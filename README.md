# ColdstartMHDTI

This repository implements the ColdstartMHDTI framework proposed in **ColdstartMHDTI.pdf** for drug–target interaction (DTI) prediction. The model builds a heterogeneous multi-hop graph over drugs, targets, diseases, and drug side effects, and fuses multiple metapaths at the semantic level to support warm-start training, drug-side cold-start, target-side cold-start, and EGFR/ESR1 case studies.

## Repository Layout

- `hetero_dataset/`: raw heterogeneous networks, features, split files, plus cached data generated by preprocessing.
- `model/`: implementations of `MAGNN_lp` and backbone layers (multi-head attention + Transformer-based semantic fusion).
- `utils/`: data loading and batching logic (`data.py`, `data_coldstart_drug.py`, etc.) and case-study specific utilities.
- `run_*.py`: entry scripts for warm-start (`run_dti.py`), drug cold-start, target cold-start, and EGFR/ESR1 experiments.
- `train_preprocess*.py`: preprocessing pipelines that generate `processed_*` caches for each scenario.

## Dataset Overview

> The statistics below come from `hetero_dataset/data`. The `data_luo` version matches the main experiments in the paper.

- **Nodes** (type mask order: Drug=0, Protein=1, Disease=2, SideEffect=3)
  - Drug: 2,214
  - Protein/Target: 1,968
  - Disease: 7,205
  - Side-effect: 3,935
- **Relations** (`mat_data/*.txt` or other edge lists)
  - Drug–Protein: 2,215 known interactions
  - Drug–Drug / Protein–Protein: 2,215 / 1,969 similarity or interaction links
  - Drug–Disease, Drug–SideEffect, Protein–Disease: 2,215 / 2,215 / 1,969 links
- **Feature files**
  - Pre-trained embeddings for drugs/targets (`.pt`) and diseases/side effects (`.npy`) live under `hetero_dataset/{data|data_luo}/`.
  - `get_features` supports `feats_type=0/1/2/3`; the default `feats_type=3` expects paths for all four node types.
- **Split files**
  - Warm-start: `train_pos.json`, `train_neg.json`, etc. (example: 6,125 / 6,153 positive/negative pairs).
  - Drug cold-start: `train_drug_coldstart.json`, ensuring non-overlapping drugs per split.
  - Target cold-start: `train_target_coldstart.json`, ensuring non-overlapping targets.
  - Case studies: `train_case_study_*.json` (EGFR training positives 8,738, negatives 17,476).

Before training, run the appropriate `train_preprocess*.py` script to create `node_types.npy` and `repeat{rp}/{mode}/{split}` caches under `hetero_dataset/{data|data_luo}/processed*`. These caches store metapath adjacency lists for fast loading in `utils.data*`.

## Environment & Dependencies

Recommended setup (matches the paper):

- Ubuntu 20.04+ or macOS 14, NVIDIA GPU ≥16 GB with CUDA 11.8.
- Python 3.9 – 3.11.
- Key packages: `torch` (>=2.0 with matching `torchvision`), `dgl` (e.g., `dgl-cu118`), `numpy`, `pandas`, `scikit-learn`, `scipy`, `networkx`.

Example Conda environment:

```bash
conda create -n coldstartmhdti python=3.10
conda activate coldstartmhdti
pip install torch==2.2.2 torchvision==0.17.2 --index-url https://download.pytorch.org/whl/cu118
pip install dgl-cu118 numpy pandas scikit-learn scipy networkx
```

For CPU-only debugging, install the CPU build of `dgl` and pass `--device cpu`.

## Data Preprocessing

Each experimental setting requires its own preprocessing script (update `data_set`/`data_dir` to your absolute path; default `./hetero_dataset/{}/`):

| Scenario | Script | Output directory |
| --- | --- | --- |
| Warm-start | `train_preprocess.py` | `hetero_dataset/data_luo/processed` |
| Drug cold-start | `train_preprocess_DrugColdstart.py` | `hetero_dataset/data_luo/processed_coldstart_drug` |
| Target cold-start | `train_preprocess_ProteinColdstart.py` | `hetero_dataset/data_luo/processed_coldstart_protein` |
| Case study (EGFR/ESR1) | `train_preprocess.py` (data variant) or custom | `hetero_dataset/data/processed_case_study_*` |

Key preprocessing steps:
1. Load `mat_data/*.txt` to build drug/protein similarity graphs and cross-modal relations.
2. Enumerate metapaths from the paper (e.g., `(0,1,0)`, `(0,2,1,2,0)`) and produce adjacency lists.
3. Respect the visibility rules of each split (warm, cold, case study) and write the caches under `processed_*`.

### Node Initialization Details

The initial embeddings for the four node types are generated by the scripts inside `Pretrain/`. Each script exports the features that later appear in `hetero_dataset/{data|data_luo}/embeddings_*.{pt,npy}`:

- Drugs (`type 0`): molecule encoders in `Pretrain/drug/` transform SMILES or fingerprints into the tensor saved as `embeddings_drug.pt`.
- Targets/Proteins (`type 1`): sequence encoders in `Pretrain/protein/` derive `embeddings_prot.pt`.
- Diseases (`type 2`): textual/ontology encoders in `Pretrain/disease/` produce `embeddings_dise.npy`.
- Side effects (`type 3`): co-occurrence embeddings in `Pretrain/side_effect/` generate `embeddings_se.npy`.

Refer to the methodology discussion in `ColdstartMHDTI.pdf` (node initialization section) for the architectural choices, loss functions, and hyperparameters used by these pretraining pipelines.

## How to Run

> Always prefer absolute paths in commands. Example placeholder: `DATA_ROOT=/Users/hongyangyang/Desktop/论文代码/hetero_dataset`.

### 1. Warm-start (all nodes visible)

1. Run `train_preprocess.py` to create `processed/`.
2. Update `split_dir` in `run_dti.py` (default `/home/yanghongyang/...`) and pass absolute feature paths, e.g.:
   ```bash
   python run_dti.py \
     --device cuda:0 \
     --data_dir "$DATA_ROOT/{}/" \
     --drug_feat_path "$DATA_ROOT/data_luo/embeddings_drug.pt" \
     --protein_feat_path "$DATA_ROOT/data_luo/embeddings_prot.pt" \
     --disease_feat_path "$DATA_ROOT/data_luo/embeddings_dise.npy" \
     --side_feat_path "$DATA_ROOT/data_luo/embeddings_se.npy" \
     --batch_size 256 --epoch 200 --samples 100
   ```
3. Outputs appear in `results_dpp/<dataset>/repeat<rp>/.../`:
   - `checkpoint/checkpoint.pt`: best validation model
   - `results.csv`: validation/test AUC & AUPR
   - `embed/*.npz`: intermediate embeddings for train/valid/test splits

### 2. Drug-side cold-start

1. Run `train_preprocess_DrugColdstart.py` to build `processed_coldstart_drug`.
2. Adjust `split_dir` in `run_dti_drugcold.py` and run:
   ```bash
   python run_dti_drugcold.py \
     --device cuda:0 \
     --data_dir "$DATA_ROOT/{}/" \
     --batch_size 256 --epoch 200 \
     --drug_feat_path "$DATA_ROOT/data_luo/embeddings_drug.pt" \
     --protein_feat_path "$DATA_ROOT/data_luo/embeddings_prot.pt" \
     --disease_feat_path "$DATA_ROOT/data_luo/embeddings_dise.npy" \
     --side_feat_path "$DATA_ROOT/data_luo/embeddings_se.npy"
   ```
3. Results share the same layout as warm-start (prefix `LLM_Drugstart_trans...`).

### 3. Target-side cold-start

Mirrors the drug cold-start setup but uses `train_preprocess_ProteinColdstart.py` and `run_dti_proteincold.py`, producing `processed_coldstart_protein`.

### 4. EGFR / ESR1 case studies

1. Use data under `hetero_dataset/data` and ensure `processed_case_study_EGFR` (or ESR1) exists.
2. Update `split_dir = "/home/.../hetero_dataset/data"` inside `run_casestudy_EGFR.py` / `run_casestudy_ESR1.py`.
3. Sample command:
   ```bash
   python run_casestudy_EGFR.py \
     --device cuda:0 \
     --data_dir "$DATA_ROOT/{}/" \
     --batch_size 256 --epoch 100 \
     --lr 5e-4 --predictor gcn --semantic_fusion attention
   ```
4. Scores with `topk_ratio=0.5` are written to `scores/test_scores.csv`, enabling reproduction of the ranking tables in the paper.

## Logs & Outputs

- Training logs are redirected to `results_dpp/.../log.txt`.
- `test_pred_results.json` records final test AUC/AUPR; case-study scripts also dump per-pair scores under `scores/`.
- Append `--only_test True` to any `run_*.py` command to load `checkpoint.pt` and evaluate only.

## Tips & FAQ

- **Path overrides**: all scripts ship with the author’s absolute paths; replace the defaults for `--data_dir` and in-script `split_dir`. Quote paths containing spaces.
- **Random seeds**: `setup_seed(20)` is applied globally. Increase `--repeat` to replicate multi-run reporting.
- **GPU memory**: reduce `--batch_size`, `--samples`, or switch to `--device cpu` when debugging.
- **Paper parity**: to match the reported results, reuse the hyperparameters described in `ColdstartMHDTI.pdf` (e.g., hidden size 128, attention heads 8, AdamW lr 2e-4) and keep the `data_luo` splits untouched.

Refer to `ColdstartMHDTI.pdf` for background on the cold-start scenarios, metapath construction, and Transformer-based semantic aggregation.


